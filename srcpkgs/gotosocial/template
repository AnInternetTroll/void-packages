# Template file for 'gotosocial'
pkgname=gotosocial
version=0.13.0
revision=1
build_style=go
go_import_path="github.com/superseriousbusiness/gotosocial"
go_package="github.com/superseriousbusiness/gotosocial/cmd/gotosocial"
hostmakedepends="go-swagger yarn"
conf_files="/etc/gotosocial/config.yaml"
make_dirs="/var/lib/gotosocial 0755 _gotosocial _gotosocial"
short_desc="Fast, fun, ActivityPub server, powered by Go"
maintainer="Luca Matei Pintilie <luca@lucamatei.com>"
license="AGPL-3.0-only"
homepage="https://gotosocial.org/"
changelog="https://github.com/superseriousbusiness/gotosocial/releases"
distfiles="https://github.com/superseriousbusiness/gotosocial/releases/download/v$version/gotosocial-$version-source-code.tar.gz"
 # https://github.com/superseriousbusiness/gotosocial/releases/download/v$version/gotosocial_${version}_web-assets.tar.gz"
checksum="c2dd75c3f2e5700da15297aea1f3c2dc7c5f883e3c83b7632c1bf6128de4f0ce"
 # 68fc637defb47f885405fc011faecbb11d7f2afff8dac3e1947c265660dfa77d"
system_accounts="_gotosocial"

post_build() {
	yarn --cwd ./web/source install --frozen-lockfile
	yarn --cwd ./web/source ts-patch install
	yarn --cwd ./web/source build
	swagger generate spec -o ./web/assets/swagger.yaml --scan-models
}

post_install() {
	vmkdir etc/gotosocial
	rm -rf web/source
	cp -r web "$DESTDIR/etc/gotosocial/"
	vsconf example/apparmor/gotosocial gotosocial.apparmor
	cp example/config.yaml "$DESTDIR/etc/gotosocial/"
	vsed -i "$DESTDIR/etc/gotosocial/config.yaml" -e 's#./web#/etc/gotosocial/web#; s#"/gotosocial/#"/var/lib/gotosocial/#'
	vsed -i "$DESTDIR/etc/gotosocial/web/assets/swagger.yaml" -e "s/REPLACE_ME/$version/"
	vlicense LICENSE
	vsv gotosocial
}
